name: Telegram Notify

on:
  release:
    types: [published]
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Gather and Clean Data
        id: info
        run: |
          # Fallback values
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          TOPIC_ID="${{ secrets.TELEGRAM_TOPIC_ID }}"
          echo "final_chat_id=${CHAT_ID:- -1001653455300}" >> $GITHUB_OUTPUT
          echo "final_topic_id=${TOPIC_ID:-71370}" >> $GITHUB_OUTPUT

          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"

          if [[ "$EVENT" == "release" || "$EVENT" == "workflow_dispatch" ]]; then
            if [[ "$EVENT" == "workflow_dispatch" ]]; then
              DATA=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest)
              RAW_BODY=$(echo "$DATA" | jq -r .body)
              TAG=$(echo "$DATA" | jq -r .tag_name)
              URL=$(echo "$DATA" | jq -r .html_url)
              USER=$(echo "$DATA" | jq -r .author.login)
            else
              RAW_BODY="${{ github.event.release.body }}"
              TAG="${{ github.event.release.tag_name }}"
              URL="${{ github.event.release.html_url }}"
              USER="${{ github.event.release.author.login }}"
            fi
            
            # CLEANUP LOGIC
            # 1. Escape HTML special chars
            # 2. Convert * bullets to -
            # 3. Remove Markdown images ![alt](url)
            # 4. Remove Header hashes ###
            CLEAN_BODY=$(echo "$RAW_BODY" | \
              sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' | \
              sed 's/^\* /  - /g' | \
              sed 's/!\[.*\](.*)//g' | \
              sed 's/^#* //g')

            TITLE="ðŸ“¦ <a href='$URL'><b>RELEASE: $TAG</b></a>"
            MSG="<b>By:</b> $USER%0A%0A$CLEAN_BODY"

          elif [[ "$EVENT" == "issues" ]]; then
            STATUS=$([[ "$ACTION" == "opened" ]] && echo "ðŸŸ¢ NEW ISSUE" || echo "ðŸ”´ CLOSED ISSUE")
            CLEAN_ISSUE=$(echo "${{ github.event.issue.body }}" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' | head -c 500)
            TITLE="<b>$STATUS: ${{ github.event.issue.title }}</b>"
            MSG="<b>User:</b> ${{ github.event.issue.user.login }}%0A%0A$CLEAN_ISSUE%0A%0A<a href='${{ github.event.issue.html_url }}'>View Issue</a>"

          elif [[ "$EVENT" == "pull_request" ]]; then
            [[ "$ACTION" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]] && STATUS="ðŸ’œ MERGED PR" || STATUS="ðŸ”µ PR $ACTION"
            TITLE="<b>$STATUS: ${{ github.event.pull_request.title }}</b>"
            MSG="<b>Author:</b> ${{ github.event.pull_request.user.login }}%0A<a href='${{ github.event.pull_request.html_url }}'>View PR Changes</a>"
          fi

          {
            echo "title<<EOF"
            echo "$TITLE"
            echo "EOF"
            echo "msg<<EOF"
            echo "$MSG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ steps.info.outputs.final_chat_id }}
          TOPIC_ID: ${{ steps.info.outputs.final_topic_id }}
          TITLE: ${{ steps.info.outputs.title }}
          MESSAGE: ${{ steps.info.outputs.msg }}
        run: |
          FULL_TEXT=$(printf "$TITLE\n\n$MESSAGE")
          
          # We use jq to handle the final JSON construction to prevent payload breakage
          jq -n \
            --arg chat_id "$CHAT_ID" \
            --arg thread_id "$TOPIC_ID" \
            --arg text "$FULL_TEXT" \
            '{
              chat_id: $chat_id, 
              message_thread_id: $thread_id, 
              text: $text, 
              parse_mode: "HTML",
              disable_web_page_preview: true
            }' > payload.json

          curl -X POST -H "Content-Type: application/json" -d @payload.json https://api.telegram.org/bot$BOT_TOKEN/sendMessage
